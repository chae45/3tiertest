name: WAS (Board API) CI to ACR

on:
  push:
    branches: [ "main" ]
    paths:
      - 'board-api/**'
      - 'pom.xml'
      
env:
  ACR_NAME: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE: ${{ secrets.IMAGE_NAME }}
  TAG: ${{ github.sha }}
  SERVICE_PATH: 'board-api'
  DOCKERFILE_PATH: 'board-api/Dockerfile'

jobs:
  build-board-api-and-push-to-acr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ğŸ› ï¸ 1ë‹¨ê³„: Java/Maven í™˜ê²½ ì„¤ì • ë° ë¹Œë“œ
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # í”„ë¡œì íŠ¸ì— ë§ëŠ” ë²„ì „ ì‚¬ìš©

    - name: Maven Build (board-api)
      # working-directory ë•ë¶„ì— 'board-api' í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
      working-directory: ${{ env.SERVICE_PATH }}
      run: |
        # ğŸš¨ [í•µì‹¬ ìˆ˜ì •] ì´ ëª…ë ¹ì–´ê°€ board-api/pom.xml íŒŒì¼ì„ ì°¾ì•„ ë¹Œë“œí•©ë‹ˆë‹¤.
        mvn clean package 
        # ë¹Œë“œ ì„±ê³µ ì‹œ, board-api/target/*.jar íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.

    # ğŸ”‘ 2ë‹¨ê³„: Azureì— ì„œë¹„ìŠ¤ ì£¼ì²´ë¡œ ë¡œê·¸ì¸
    - name: Azure CLI Login (Service Principal)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # ğŸ”‘ 3ë‹¨ê³„: Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ ACRì— ë¡œê·¸ì¸
    - name: Docker Login to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_NAME }}
        username: ${{ secrets.AZURE_CLIENT_ID }} 
        password: ${{ secrets.AZURE_CLIENT_SECRET }} 

    # ğŸ”‘ 4ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ACRì— í‘¸ì‹œ
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        # contextê°€ board-apiì´ë¯€ë¡œ, Dockerfile ë‚´ë¶€ì—ì„œ target/*.jarì„ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        context: ${{ env.SERVICE_PATH }}
        push: true
        tags: ${{ env.ACR_NAME }}/${{ env.IMAGE }}:${{ env.TAG }}
        file: ${{ env.DOCKERFILE_PATH }}
