name: WAS (Board API) CI to ACR

on:
  push:
    branches: [ "main" ]
    paths:
      - 'board-api/**'
      - 'pom.xml'
      
env:
  IMAGE_NAME: board-was # ACR 로그인 서버 변수는 아래에서 직접 참조합니다.
  
jobs:
  build-board-api-and-push-to-acr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build WAS (Board API) with Maven
      run: |
        cd board-api
        mvn clean package -DskipTests
        
    # 1. Azure 로그인 (Service Principal 사용)
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 2. ACR 인증 정보 추출 (JSON 파싱)
    - name: Set ACR Credentials
      id: acr_creds
      shell: bash
      run: |
        # jq를 사용하여 JSON에서 clientId와 clientSecret 추출
        CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')
        CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
        echo "ACR_CLIENT_ID=$CLIENT_ID" >> $GITHUB_ENV
        echo "ACR_CLIENT_SECRET=$CLIENT_SECRET" >> $GITHUB_ENV

    # 3. Docker에 ACR 로그인 (권한 부족 오류 해결)
    - name: Log into Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ env.ACR_CLIENT_ID }}
        password: ${{ env.ACR_CLIENT_SECRET }}
        
    # 4. Docker 이미지 빌드 및 ACR로 푸시
    - name: Build and push Docker image to ACR
      uses: docker/build-push-action@v5
      with:
        context: ./board-api
        push: true
        # registry와 tags 분리로 태그 형식 오류 해결
        registry: ${{ secrets.ACR_LOGIN_SERVER }}
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
        file: ./board-api/Dockerfile
        
    # 5. Azure 로그아웃
    - name: Logout from Azure
      run: az logout
      if: always()
