name: WAS (Board API) CI to ACR (Admin User)

on:
  push:
    branches: [ "main" ]
    # board-api í´ë”ë‚˜ ê³µí†µ pom.xmlì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'board-api/**'
      - 'pom.xml'
      
env:
  ACR_NAME: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE: board-api
  TAG: ${{ github.sha }}
  # board-api í´ë”ì— pom.xmlê³¼ Dockerfileì´ ìˆë‹¤ê³  ê°€ì •
  SERVICE_PATH: 'board-api' 

jobs:
  build-and-push-to-acr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ğŸ› ï¸ 1ë‹¨ê³„: Java 8 í™˜ê²½ ì„¤ì • ë° Maven ë¹Œë“œ
    - name: Set up Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8' # ğŸ’¡ Dockerfileì˜ OpenJDK 8ì— ë§ì¶° Java 8 ì‚¬ìš©

    - name: Maven Build (board-api)
      # pom.xmlì´ board-api í´ë”ì— ìˆìœ¼ë¯€ë¡œ working-directory ì„¤ì •ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
      working-directory: ${{ env.SERVICE_PATH }}
      run: mvn clean package 
      # ë¹Œë“œ ì„±ê³µ ì‹œ, board-api/target/*.jar íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.

    - name: Docker Login to ACR (Admin User)
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }} 
        password: ${{ secrets.ACR_PASSWORD }}


    # ğŸ”‘ 3ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ACRì— í‘¸ì‹œ
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        # context: Dockerfileì´ ë¹Œë“œí•  íŒŒì¼ì„ ì°¸ì¡°í•˜ëŠ” ê¸°ì¤€ í´ë” (board-api)
        # Dockerfileì€ context ë‚´ì˜ target/*.jar íŒŒì¼ì„ ì°¸ì¡°í•˜ê²Œ ë©ë‹ˆë‹¤.
        context: ${{ env.SERVICE_PATH }} 
        push: true
        tags: ${{ env.ACR_NAME }}/${{ env.IMAGE }}:${{ env.TAG }},${{ env.ACR_NAME }}/${{ env.IMAGE }}:latest
        # file: Dockerfileì˜ ê²½ë¡œ (board-api/Dockerfile)
        file: ${{ env.SERVICE_PATH }}/Dockerfile
