name: WAS (Board API) CI to ACR

on:
  push:
    branches: [ "main" ]
    paths:
      - 'board-api/**'
      - 'pom.xml'
      
env:
  ACR_NAME: ${{ secrets.ACR_LOGIN_SERVER }} # ì˜ˆ: myregistry.azurecr.io
  IMAGE: ${{ secrets.IMAGE_NAME }}        # ì˜ˆ: my-web-app
  TAG: ${{ github.sha }}
  
jobs:
  build-board-api-and-push-to-acr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

# ğŸ”‘ 1ë‹¨ê³„: Azureì— ì„œë¹„ìŠ¤ ì£¼ì²´ë¡œ ë¡œê·¸ì¸
      - name: Azure CLI Login (Service Principal)
        uses: azure/login@v1
        with:
          # ì¶”ì¶œí•œ Secret ë³€ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          # ACR ì ‘ê·¼ì— í•„ìš”í•œ ì—­í• (AcrPush)ì´ ì´ ì„œë¹„ìŠ¤ ì£¼ì²´ì— í• ë‹¹ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

      # ğŸ”‘ 2ë‹¨ê³„: Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ ACRì— ë¡œê·¸ì¸
      - name: Docker Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}
          # Docker ë¡œê·¸ì¸ ì‹œ, ì„œë¹„ìŠ¤ ì£¼ì²´ì˜ Client IDì™€ Secretì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          username: ${{ secrets.AZURE_CLIENT_ID }} 
          password: ${{ secrets.AZURE_CLIENT_SECRET }} 

      # ğŸ”‘ 3ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ACRì— í‘¸ì‹œ
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: . 
          push: true
          tags: ${{ env.ACR_NAME }}/${{ env.IMAGE }}:${{ env.TAG }}
          file: ./Dockerfile
