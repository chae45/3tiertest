name: WAS (Board API) CI to ACR

on:
  push:
    branches: [ "main" ]
    # board-api ë””ë ‰í† ë¦¬ ë˜ëŠ” ê³µí†µ pom.xml ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
    paths:
      - 'board-api/**'
      - 'pom.xml'
      
env:
  ACR_NAME: ${{ secrets.ACR_LOGIN_SERVER }} 
  IMAGE: ${{ secrets.IMAGE_NAME }}        
  TAG: ${{ github.sha }}
  # ğŸ’¡ [ì¶”ê°€] board-apiì˜ ì†ŒìŠ¤ ì½”ë“œ ê²½ë¡œì™€ Dockerfile ê²½ë¡œ ì§€ì •
  SERVICE_PATH: 'board-api'
  DOCKERFILE_PATH: 'board-api/Dockerfile' # Dockerfileì´ board-api í´ë” ë‚´ì— ìˆë‹¤ê³  ê°€ì •

jobs:
  build-board-api-and-push-to-acr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ğŸ› ï¸ [ì¶”ê°€] 1ë‹¨ê³„: Java/Maven í™˜ê²½ ì„¤ì • ë° ë¹Œë“œ
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # í”„ë¡œì íŠ¸ì— ë§ëŠ” Java ë²„ì „ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”

    - name: Maven Build (board-api)
      run: |
        # ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤. board-apiì˜ ë¹Œë“œ ê²°ê³¼ë¬¼(jar/war)ì´ ìƒì„±ë©ë‹ˆë‹¤.
        mvn clean package -f pom.xml

    # ğŸ”‘ 2ë‹¨ê³„: Azureì— ì„œë¹„ìŠ¤ ì£¼ì²´ë¡œ ë¡œê·¸ì¸
    - name: Azure CLI Login (Service Principal)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # ğŸ”‘ 3ë‹¨ê³„: Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ ACRì— ë¡œê·¸ì¸
    - name: Docker Login to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_NAME }}
        username: ${{ secrets.AZURE_CLIENT_ID }} 
        password: ${{ secrets.AZURE_CLIENT_SECRET }} 

    # ğŸ”‘ 4ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ACRì— í‘¸ì‹œ
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        # ğŸ’¡ [ìˆ˜ì •] contextë¥¼ Dockerfileì´ ìˆëŠ” ë””ë ‰í† ë¦¬ë¡œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        # Dockerfile ë‚´ì—ì„œ ë¹Œë“œ ê²°ê³¼ë¬¼(ì˜ˆ: board-api/target/*.jar)ì„ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
        context: ${{ env.SERVICE_PATH }}
        push: true
        tags: ${{ env.ACR_NAME }}/${{ env.IMAGE }}:${{ env.TAG }}
        # ğŸ’¡ [ìˆ˜ì •] Dockerfile ê²½ë¡œë¥¼ ì •í™•íˆ ì§€ì •í•©ë‹ˆë‹¤.
        file: ${{ env.DOCKERFILE_PATH }}
